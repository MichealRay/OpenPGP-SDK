#!/usr/bin/perl -w

use strict;

use Carp;

our %Subst;

my %Args=(
	  '--help' => \&usage,
	  '--use-dmalloc' => sub {
	      $Subst{DM_FLAGS}='-I/usr/local/include -DDMALLOC';
	      $Subst{DM_LIB}='/usr/local/lib/libdmalloc.a';
	  },
	  '--with-openssl=' => sub {
	      my $loc=shift;
	      $Subst{INCLUDES}.=" -I $loc/include";
	  },
	  '--with-zlib=' => sub {
	      my $loc=shift;
	      $Subst{INCLUDES}.=" -I $loc/include";
	  },
	 );

our %Knowledge=(
	       cc => sub { return chooseBinary('gcc','cc')
			     || croak 'Can\'t find C compiler'; },
	       path => sub { return [split /:/,$ENV{PATH}]; },
	      );

while(my $arg=shift) {
    my $arg2;
    if($arg =~ /^(.+=)(.+)$/) {
	$arg=$1;
	$arg2=$2;
    }
    my $code=$Args{$arg};
    croak "Don't understand: $arg" if !defined $code;
    &$code($arg2);
}

my $os=`uname -s`;

$Subst{'CC'}=getKnowledge('cc');

fixSubst();

open(D,'>.depend') || croak "Can't create .depend";
close D;

open(T,'Makefile.template') || croak "Can't open Makefile.template: $!";
open(M,'>Makefile') || croak "Can't create Makefile: $!";

print M "# generated by configure from Makefile.template. Don't edit.\n\n";

while(my $line=<T>) {
    print M subst($line);
}

close M;
close T;

system 'make clean' || exit;
system 'make force_depend' || exit;

sub subst {
    my $line=shift;

    while(my($k,$v)=each %Subst) {
	$line =~ s/\%$k\%/$v/g;
    }
    $line =~ s/\%.+?\%//g;
    return $line;
}

sub chooseBinary {
    my $path=getKnowledge('path');
    while(my $bin=shift) {
	foreach my $p (@$path) {
	    return $bin if -x "$p/$bin";
	}
    }
    return 'false';
}

sub getKnowledge {
    my $thing=shift;

    croak "Asked for nonexistent knowledge $thing"
      if !exists $Knowledge{$thing};

    if(ref $Knowledge{$thing} eq 'CODE') {
	$Knowledge{$thing}=&{$Knowledge{$thing}}();
    }
    return $Knowledge{$thing};
}

sub usage {
    foreach my $k (keys %Args) {
	print "$k\n";
    }
    exit;
}

sub fixSubst {
    foreach my $k (keys %Subst) {
	$Subst{$k} =~ s/~/\$(HOME)/g;
    }
}
