#!/usr/bin/perl -w

use strict;

use Carp;

our %Subst;

my %Args=(
	  '--use-dmalloc' => sub {
	      $Subst{DM_FLAGS}='-I/usr/local/include -DDMALLOC';
	      $Subst{DM_LIB}='/usr/local/lib/libdmalloc.a';
	  },
	 );

while(my $arg=shift) {
    my $code=$Args{$arg};
    croak "Don't understand: $arg" if !defined $code;
    &$code();
}

my $os=`uname -s`;

open(D,'>.depend') || croak "Can't create .depend";
close D;

open(T,'Makefile.template') || croak "Can't open Makefile.template: $!";
open(M,'>Makefile') || croak "Can't create Makefile: $!";

print M "# generated by configure from Makefile.template. Don't edit.\n\n";

while(my $line=<T>) {
    print M subst($line);
}

close M;
close T;

system 'make clean' || exit;
system 'make force_depend' || exit;

sub subst {
    my $line=shift;

    while(my($k,$v)=each %Subst) {
	$line =~ s/\%$k\%/$v/g;
    }
    $line =~ s/\%.+?\%//g;
    return $line;
}
